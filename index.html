<html>
<body>
<button onclick="onButtonClick()">Click me</button>
<script>
function interpretIBeacon(event) {
 var rssi = event.rssi;
 var appleData = event.manufacturerData.get(0x004C);
 if (appleData.byteLength != 23 ||
   appleData.getUint16(0, false) !== 0x0215) {
   console.log({isBeacon: false});
 }
 var uuidArray = new Uint8Array(appleData.buffer, 2, 16);
 var major = appleData.getUint16(18, false);
 var minor = appleData.getUint16(20, false);
 var txPowerAt1m = -appleData.getInt8(22);
 console.log({
     isBeacon: true,
     uuidArray,
     major,
     minor,
     pathLossVs1m: txPowerAt1m - rssi
 });
}
  
async function onButtonClick() {  
  var known_service = "4e754731-203a-45ae-9b84-ce44ce585f7e";
  return navigator.bluetooth.requestDevice({
    acceptAllDevices: true
  }).then(device => {
    console.log(device);
    device.addEventListener('advertisementreceived', interpretIBeacon);
  });
  
  let options = {};
  //options.acceptAllAdvertisements = true;
  options.filters = [{
    manufacturerData: 
    {
      0x004C: 
      {
        dataPrefix: new Uint8Array([0x02, 0x15])
      }
    }
  }];

  try {
    console.log('Requesting Bluetooth Scan with options: ' + JSON.stringify(options));
    const scan = await navigator.bluetooth.requestLEScan(options);

    console.log('Scan started with:');
    console.log(' acceptAllAdvertisements: ' + scan.acceptAllAdvertisements);
    console.log(' active: ' + scan.active);
    console.log(' keepRepeatedDevices: ' + scan.keepRepeatedDevices);
    console.log(' filters: ' + JSON.stringify(scan.filters));

    navigator.bluetooth.addEventListener('advertisementreceived', event => {
      console.log('Advertisement received.');
    });

    setTimeout(stopScan, 10000);
    function stopScan() {
      console.log('Stopping scan...');
      scan.stop();
      console.log('Stopped.  scan.active = ' + scan.active);
    }
  } catch(error)  {
    console.log('Argh! ' + error);
  }
}
</script>
</body>
</html>
